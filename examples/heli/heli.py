#!/usr/bin/python
# -*- coding: utf-8 -*-
# Must satisfy the signature
# [t,X,D,P] = sim_function(T,X0,D0,P0,I0);

import numpy as np
from scipy.integrate import ode

import pylab as plt

PLOT = False


class SIM(object):

    def __init__(self, plt, pvt_init_data):
        # atol = 1e-10
        rtol = 1e-5

        rtol = 1e-6
        nsteps = 1000

        # tt,YY,dummy_D,dummy_P
        # The orer of these calls is strict... do not change
        # (1):set_integrator -> (2):set_solout -> (3):set_initial_value

        self.solver = ode(dyn).set_integrator(
                'dopri5', rtol=rtol,
                #max_step=max_step,
                #nsteps=nsteps
                )  # (1)

    def sim(self, TT, X0, D, P, U, I, property_checker):
        num_dim_x = len(X0)
        plot_data = ([np.empty(0, dtype=float), np.empty((0, num_dim_x), dtype=float)]
                     if PLOT else None)

        #if property_checker is not None:
        #    max_step = 1e-2
        #else:
        #    max_step = 0.0

        Ti = TT[0]
        Tf = TT[1]
        T = Tf - Ti

#         if property_checker:
#             violating_state = [()]
        solver = self.solver
        solver.set_solout(solout_fun(property_checker, plot_data))  # (2)

        solver.set_initial_value(X0, t=0.0)
        solver.set_f_params(U)
        X_ = self.solver.integrate(T)

        property_violated_flag = property_checker.check(Tf, X_)

        dummy_D = np.zeros(D.shape)
        dummy_P = np.zeros(P.shape)
        ret_t = Tf
        ret_X = X_
        # ret_Y = Y
        ret_D = dummy_D
        ret_P = dummy_P

        #plt.plot(plot_data[0] + Ti, plot_data[1][:, 0])
        if PLOT:
            plt.plot(plot_data[1][:, 28], plot_data[1][:, 5])
        ##plt.plot(plot_data[0] + Ti, np.tile(U, plot_data[0].shape))

        return (ret_t, ret_X, ret_D, ret_P), property_violated_flag


def dyn(t, X, u):
    Y = X.copy()
    Y[0] = (0.998573780060*X[3] + 0.053384274244*X[4])

    Y[1] = (1.000000000000*X[2] - 0.003182219341*X[3] +
            0.059524655342*X[4])

    Y[2] = (-11.570495605469*X[2] - 2.544637680054*X[3] -
            0.063602626324*X[4] + 0.106780529022*X[5] -
            0.094918668270*X[6] + 0.007107574493*X[7] -
            3.700790207851*X[8] - 16.213284674534*X[9] -
            2.984968535139*X[10] - 0.493137919288*X[11] -
            1.186954196152*X[12] - 0.031106608756*X[13] +
            0.024595252653*X[14] + 0.008231369923*X[15] +
            0.231787619674*X[16] + 0.745302732591*X[17] +
            7.895709940231*X[18] + 2.026930360369*X[19] +
            0.271792657736*X[20] + 0.315196108541*X[21] +
            0.015876847710*X[22] + 0.009288507454*X[23] +
            0.087920280806*X[24] - 0.103727794204*X[25] -
            4.447282126346*X[26] + 0.016271459306*X[27])

    Y[3] = (0.439356565475*X[2] - 1.998182296753*X[3] +
            0.016651883721*X[5] + 0.018462046981*X[6] -
            0.001187470742*X[7] - 7.517319654181*X[8] +
            0.236494174025*X[9] - 0.028725044803*X[10] -
            2.442989538035*X[11] + 0.034510550810*X[12] -
            0.004683216652*X[13] - 0.005154038690*X[14] -
            0.002104275246*X[15] - 0.079935853309*X[16] +
            1.420125114638*X[17] - 0.117856066698*X[18] -
            0.226142434271*X[19] - 0.002585832387*X[20] -
            0.001365917341*X[21] + 0.035962654791*X[22] +
            0.028993699893*X[23] - 0.045896888864*X[24] +
            0.716358354284*X[25] + 0.029085601036*X[26] -
            0.001242728387*X[27])

    Y[4] = (-2.040895462036*X[2] - 0.458999156952*X[3] -
            0.735027790070*X[4] + 0.019255757332*X[5] -
            0.004595622420*X[6] + 0.002120360732*X[7] -
            0.740775522612*X[8] - 2.555714688932*X[9] -
            0.339301128908*X[10] - 0.033104023297*X[11] -
            1.446467788369*X[12] - 0.007442776396*X[13] -
            0.000012314482*X[14] + 0.030657946816*X[15] +
            1.002118140789*X[16] + 0.153644862643*X[17] +
            1.273828227991*X[18] + 1.983204935524*X[19] +
            0.048757213739*X[20] + 0.060295617991*X[21] +
            0.001605314985*X[22] + 0.000554368427*X[23] +
            0.475422075598*X[24] - 0.010880647601*X[25] -
            0.775712358056*X[26] - 0.408545111762*X[27])

    Y[5] = (-32.103607177734*X[0] - 0.503355026245*X[2] +
            2.297859191895*X[3] - 0.021215811372*X[5] -
            0.021167919040*X[6] + 0.015811592340*X[7] +
            8.689411857722*X[8] - 0.215429806172*X[9] +
            0.063500560122*X[10] + 2.847523923644*X[11] -
            0.297021616015*X[12] + 0.001323463163*X[13] +
            0.002124820781*X[14] + 0.068860932948*X[15] +
            1.694077894544*X[16] - 1.639571645676*X[17] +
            0.110652545728*X[18] + 0.728735301618*X[19] +
            0.003107735169*X[20] + 0.003335187976*X[21] -
            0.042347579477*X[22] - 0.034247794709*X[23] +
            0.469091132962*X[24] - 0.814424502262*X[25] -
            0.018082452136*X[26] + 0.016747349252*X[27])

    Y[6] = (0.102161169052*X[0] + 32.057830810547*X[1] -
            2.347217559814*X[2] - 0.503611564636*X[3] +
            0.834947586060*X[4] + 0.021226570010*X[5] -
            0.037879735231*X[6] + 0.000354003860*X[7] -
            0.560681623936*X[8] - 3.574948145694*X[9] -
            0.788176766644*X[10] - 0.107590635594*X[11] +
            0.908657075077*X[12] - 0.008720966051*X[13] +
            0.005669792925*X[14] + 0.044884407612*X[15] +
            0.788227489086*X[16] + 0.111065913657*X[17] +
            1.709840089441*X[18] - 0.946574755181*X[19] +
            0.054255711842*X[20] + 0.060392345409*X[21] +
            0.003299051857*X[22] + 0.001965592530*X[23] -
            0.035607238660*X[24] - 0.021984114632*X[25] -
            0.893130060176*X[26] + 0.503048977806*X[27])

    Y[7] = (-1.910972595215*X[0] + 1.713829040527*X[1] -
            0.004005432129*X[2] - 0.057411193848*X[3] +
            0.013989634812*X[5] - 0.000906753354*X[6] -
            0.290513515472*X[7] - 1.440209153996*X[8] -
            1.089782421583*X[9] - 0.599051729911*X[10] -
            0.930901394778*X[11] + 5.044060722850*X[12] +
            0.079229241316*X[13] + 0.074101747848*X[14] -
            1.301808243838*X[15] - 31.393874531397*X[16] +
            0.233327947688*X[17] + 0.478559456452*X[18] -
            9.198865975131*X[19] - 0.002820980233*X[20] -
            0.034669033757*X[21] + 0.022125233836*X[22] +
            0.019923408940*X[23] - 8.159414332666*X[24] -
            0.129736796488*X[25] - 0.298841506489*X[26] -
            0.300193732750*X[27])

    Y[8] = (0.050176870833*X[0] - 0.003161246171*X[1] -
            0.486165175190*X[2] + 0.266534777047*X[3] +
            0.003826227932*X[4] + 0.000001339204*X[5] +
            0.000001199431*X[6] - 0.000022435600*X[7] -
            0.020657323970*X[8] + 0.001301453941*X[9] +
            0.213359280279*X[10] + 0.881596311923*X[11] +
            0.051809053856*X[12] - 0.000000551337*X[13] -
            0.000000493794*X[14] + 0.000009236516*X[15])

    Y[9] = (-0.019757788570*X[0] + 0.009012833714*X[1] +
            0.311015942657*X[2] + 2.810181204790*X[3] -
            0.001602140073*X[4] - 0.000000613279*X[5] -
            0.000000549271*X[6] + 0.000010274224*X[7] +
            0.008134087133*X[8] - 0.003710494952*X[9] +
            0.863507011470*X[10] - 1.236460821044*X[11] +
            0.060184240645*X[12] + 0.000000252481*X[13] +
            0.000000226129*X[14] - 0.000004229797*X[15])

    Y[10] = (-0.030385323449*X[0] + 0.003110159427*X[1] +
             0.312812882924*X[2] + 0.287354391281*X[3] -
             0.002331730630*X[4] - 0.000000824205*X[5] -
             0.000000738183*X[6] + 0.000013807861*X[7] -
             8.414922645141*X[8] - 36.922139523656*X[9] -
             18.505141519315*X[10] - 3.793715804769*X[11] -
             2.765572372983*X[12] + 0.035944961732*X[13] -
             0.038910104720*X[14] + 0.025846348888*X[15] +
             0.527826299191*X[16] + 1.697201876759*X[17] +
             17.980094722474*X[18] + 4.615721721183*X[19] +
             0.618925691035*X[20] + 0.717763941510*X[21] +
             0.036154725527*X[22] + 0.021151770407*X[23] +
             0.200211885807*X[24] - 0.236208723376*X[25] -
             10.127341872304*X[26] + 0.037053334254*X[27])

    Y[11] = (0.002667394037*X[0] + 0.004496152836*X[1] +
             0.045956750452*X[2] + 1.764514260408*X[3] +
             0.000146052012*X[4] + 0.000000019584*X[5] +
             0.000000017540*X[6] - 0.000000328097*X[7] -
             17.119523267503*X[8] + 0.536693033369*X[9] +
             0.353775293385*X[10] - 8.335731095093*X[11] +
             0.078527228401*X[12] + 0.005987264162*X[13] +
             0.006725273267*X[14] - 0.005979187005*X[15] -
             0.182029763642*X[16] + 3.233906041666*X[17] -
             0.268381596955*X[18] - 0.514971094398*X[19] -
             0.005888452287*X[20] - 0.003110464210*X[21] +
             0.081894084826*X[22] + 0.066024394813*X[23] -
             0.104516302587*X[24] + 1.631289796960*X[25] +
             0.066233671911*X[26] - 0.002829938571*X[27])

    Y[12] = (0.024056576806*X[0] - 0.001361685819*X[1] -
             0.230715295944*X[2] + 0.185551143531*X[3] +
             0.001832537128*X[4] + 0.000000640359*X[5] +
             0.000000573525*X[6] - 0.000010727892*X[7] -
             1.696796379292*X[8] - 5.819307733117*X[9] -
             2.712299197847*X[10] - 0.615817527040*X[11] -
             4.029675752634*X[12] + 0.002306818331*X[13] -
             0.004623901048*X[14] + 0.071938991843*X[15] +
             2.282021405408*X[16] + 0.349879770769*X[17] +
             2.900759066988*X[18] + 4.516150272075*X[19] +
             0.111029828612*X[20] + 0.137305059460*X[21] +
             0.003655620040*X[22] + 0.001262406662*X[23] +
             1.082630189953*X[24] - 0.024777388732*X[25] -
             1.766450614425*X[26] - 0.930338103031*X[27])

    Y[13] = (-1.753103616578*X[0] + 0.521869609890*X[1] +
             23.319318958026*X[2] + 145.082271971311*X[3] -
             0.138741289403*X[4] - 0.000051341929*X[5] -
             0.000045983385*X[6] + 0.000860128319*X[7] -
             11.594360544437*X[8] - 0.705424902410*X[9] -
             10.592707880324*X[10] - 54.888617486514*X[11] -
             0.619258600252*X[12] - 0.018180886764*X[13] -
             0.016310350542*X[14] + 0.172267463350*X[15] +
             3.857750758541*X[16] - 3.733629238750*X[17] +
             0.251977753557*X[18] + 1.659474556422*X[19] +
             0.007076928248*X[20] + 0.007594883320*X[21] -
             0.096433822422*X[22] - 0.077989008913*X[23] +
             1.068213380174*X[24] - 1.854605830991*X[25] -
             0.041177323469*X[26] + 0.038137029879*X[27])

    Y[14] = (1.708539622488*X[0] + 0.111898315003*X[1] -
             13.174473231922*X[2] + 91.462755556230*X[3] +
             0.127584976026*X[4] + 0.000043171229*X[5] +
             0.000038665459*X[6] - 0.000723245056*X[7] -
             1.878010842263*X[8] + 23.870898681235*X[9] +
             1.639719754761*X[10] - 40.888303474223*X[11] +
             2.851614162302*X[12] + 0.001349430570*X[13] -
             0.024984412428*X[14] + 0.102862439056*X[15] +
             1.794950045519*X[16] + 0.252919074168*X[17] +
             3.893644396914*X[18] - 2.155538119928*X[19] +
             0.123550997381*X[20] + 0.137525326941*X[21] +
             0.007512594224*X[22] + 0.004476043338*X[23] -
             0.081084731931*X[24] - 0.050062181420*X[25] -
             2.033833968448*X[26] + 1.145542115841*X[27])

    Y[15] = (-0.069753861204*X[0] + 0.041269247265*X[1] +
             1.243498527057*X[2] + 13.467483657041*X[3] -
             0.005772466581*X[4] - 0.000002269708*X[5] -
             0.000002032820*X[6] + 0.000038024292*X[7] -
             5.161896992464*X[8] - 0.784811430978*X[9] -
             1.913888711445*X[10] - 8.087612492321*X[11] +
             11.488701354150*X[12] + 0.194411237470*X[13] +
             0.167838434014*X[14] - 3.255004272242*X[15] -
             71.490067651024*X[16] + 0.531333931032*X[17] +
             1.089774627294*X[18] - 20.947639012098*X[19] -
             0.006423930487*X[20] - 0.078948253623*X[21] +
             0.050383537787*X[22] + 0.045369546582*X[23] -
             18.580601832107*X[24] - 0.295436370828*X[25] -
             0.680521274763*X[26] - 0.683600561672*X[27])

    Y[16] = (-0.013549327978*X[5] - 0.012135188033*X[6] +
             0.226991094595*X[7])

    Y[17] = (-11.385989897412*X[0])

    Y[18] = (-4.554395958965*X[1])

    Y[19] = (0.243569095885*X[3] - 4.554395958965*X[4])

    Y[20] = (-4.554395958965*X[2] - 8.500000000000*X[20] -
             18.000000000000*X[21])

    Y[21] = (1.000000000000*X[20])

    Y[22] = (-11.385989897412*X[3] - 8.500000000000*X[22] -
             18.000000000000*X[23])

    Y[23] = (1.000000000000*X[22])

    Y[24] = (0.683186075980*X[8] + 0.514736886625*X[9] +
             0.282998565164*X[10] + 0.440668616363*X[11] -
             2.382738811465*X[12] - 0.037424700426*X[13] -
             0.035002491999*X[14] + 0.614952694278*X[15] +
             14.829958398888*X[16] - 0.110759742503*X[17] -
             0.226034186438*X[18] + 4.345468653096*X[19] +
             0.001333027828*X[20] + 0.016376955559*X[21] -
             0.010465240818*X[22] - 0.009422482600*X[23] -
             6.145615181050*X[24] + 0.061014181775*X[25] +
             0.141165339638*X[26] + 0.141806743312*X[27])

    Y[25] = (-36.039354729710*X[8] + 0.767400874818*X[9] -
             0.190879388177*X[10] - 11.678174370212*X[11] -
             0.041149877278*X[12] - 0.026017271417*X[13] -
             0.026698725144*X[14] + 0.036415219598*X[15] +
             0.738656358350*X[16] + 6.810845841283*X[17] -
             0.384784957980*X[18] - 0.708557300741*X[19] -
             0.005524328707*X[20] + 0.002522572903*X[21] +
             0.171826920583*X[22] + 0.138368426838*X[23] +
             0.071909684799*X[24] - 6.567495145681*X[25] +
             0.039293511274*X[26] + 0.006041152866*X[27])

    Y[26] = (1.997224587333*X[8] + 13.482210983798*X[9] +
             2.488520358003*X[10] + 0.076750797248*X[11] +
             0.804972334222*X[12] + 0.023466195202*X[13] -
             0.022740687251*X[14] + 0.018646161041*X[15] +
             0.436604617107*X[16] - 0.414374632569*X[17] -
             6.563020897889*X[18] - 1.423460802051*X[19] -
             0.224998971426*X[20] - 0.259852011779*X[21] -
             0.008437464875*X[22] - 0.003945344110*X[23] +
             0.102235829031*X[24] + 0.191829027845*X[25] -
             6.312428841540*X[26] - 0.038075090345*X[27])

    Y[27] = (1.761524247668*X[8] - 3.415298165208*X[9] -
             1.836225244248*X[10] - 0.015605131825*X[11] +
             10.486845595600*X[12] - 0.031379180918*X[13] +
             0.001266746410*X[14] + 0.525873993847*X[15] +
             9.808565668907*X[16] - 0.367529750255*X[17] +
             1.370405524130*X[18] - 12.076970057329*X[19] +
             0.004883176776*X[20] - 0.015765473705*X[21] -
             0.000399777933*X[22] - 0.000497333312*X[23] +
             0.199818976539*X[24] - 0.002648145523*X[25] -
             0.101212258081*X[26] - 5.199268943788*X[27])

    Y[28] = 1
    return Y


def solout_fun(property_checker, plot_data):

    def solout(t, Y):
        if PLOT:
            plot_data[0] = np.concatenate((plot_data[0], np.array([t])))
            plot_data[1] = np.concatenate((plot_data[1], np.array([Y])))

        # print Y
        # print t, Y
        if property_checker.check(t, Y):
            #violating_state[0] = (np.copy(t), np.copy(Y))
            print 'violation found:'#, violating_state[0]
            # return -1 to stop integration
            return -1
        else:
            return 0

    return solout
